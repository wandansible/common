---
- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"
  when: not inventory_hostname is match('(\d{1,3}\.){3}\d{1,3}')

- name: Set hostname in /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: "^127.0.1.1.+$"
    line: "127.0.1.1	{{ ansible_fqdn }} {{ ansible_hostname }}"

- name: Refresh apt cache
  apt:
    update_cache: yes

- name: Install apt mirror dependencies
  apt:
    pkg:
      - apt-transport-https
    state: present

- name: Configure apt mirror
  template:
    src: "templates/sources.list.{{ ansible_distribution|lower }}"
    dest: /etc/apt/sources.list
  when: ansible_os_family == "Debian"
  register: apt_mirror

- name: Refresh apt cache when mirror changes
  apt:
    update_cache: yes
  when: apt_mirror.changed == true

- name: Install useful packages
  apt:
    pkg: "{{ useful_packages }}"
    state: present

- name: Install intel microcode
  apt:
    pkg: "intel-microcode"
  when: ansible_processor | lower is search("intel")

- name: Install amd64 microcode
  apt:
    pkg: "amd64-microcode"
  when: ansible_processor | lower is search("amd")

- name: Install nonfree firmware
  apt:
    pkg: "firmware-linux-nonfree"
    install_recommends: no
  when: ansible_system_vendor | lower is search("dell")
